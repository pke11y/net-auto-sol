#
# Build base infrastructure configurations and services. 
# Deploy the full configuration to the nodes.
# 
# This playbook is dependent on running 'create_data_model.yml' to produce 'nodes.yml'
#
---
- hosts: mpls
  connection: network_cli
  gather_facts: no
  vars_files:
    - nodes.yml
    - common.yml
  tasks:
    - name: CREATE CONFIG DIRECTORY
      local_action: file path={{playbook_dir}}/results state=directory
      run_once: true
      check_mode: no
    - name: CREATE CONFIG
      template: src=./templates/{{ansible_network_os}}-mpls-template.j2 dest={{playbook_dir}}/results/{{inventory_hostname}}.cfg
    - name: CREATE DIFF FILES
      local_action: file path={{playbook_dir}}/results/{{inventory_hostname}}.diff state=touch
      check_mode: no
    - name: DEPLOY CONFIG TO DEVICES
      napalm_install_config:
        hostname: "{{ inventory_hostname }}"
        username: "{{ ansible_user }}"
        dev_os: "{{ ansible_network_os }}"
        password: "{{ ansible_ssh_pass }}"
        config_file: "{{playbook_dir}}/results/{{inventory_hostname}}.cfg"
        commit_changes: True
        replace_config: True
        get_diffs: True
        diff_file: "{{playbook_dir}}/results/{{inventory_hostname}}.diff"
      register: result
    - name:  GET NAPALM FACTS 
      napalm_get_facts:
        hostname: "{{ansible_host}}"
        username: "{{ansible_user}}"
        dev_os: "{{ansible_network_os}}"
        password: "{{ ansible_ssh_pass }}"
        filter: ['facts', 'interfaces', 'interfaces_ip', 'bgp_neighbors']
      register: napalm_facts
    - name: CHECK INTERFACES 
      assert:
        that:
          - "{{ item['value']['is_up'] == true }}"
        fail_msg: "Interface {{ item['key'] }} is down"
      loop: "{{ napalm_facts['ansible_facts']['napalm_interfaces'] | dict2items }}"
      when: item['value']['is_enabled'] == true
      register: interface_result
    - name: CHECK BGP NEIGHBOUR PEERING STATUS
      assert: 
        that:
          - "{{ item['value']['is_up'] == true }}"
        fail_msg: "BGP peer {{ item['key'] }} is down"
      register: bgp_result
      loop: "{{ napalm_facts['ansible_facts']['napalm_bgp_neighbors']['global']['peers']  | dict2items }}"
    - name: DEBUG VARIABLES 
      copy:
        content: "{{ vars | to_nice_yaml }}"
        dest: "{{playbook_dir}}/facts.yml"
      delegate_to: localhost
    # - name: CONFIGURATION INTERFACE DEPLOYMENT SUMMARY REPORT
    #   blockinfile:
    #     create: yes
    #     path: "{{playbook_dir}}/results/{{inventory_hostname}}_interface_report.txt"
    #     marker: "*** {mark} {{inventory_hostname}} Interface Report:"
    #     marker_begin: "{{ lookup('pipe','date') }}"
    #     marker_end: "------"
    #     block: |
    #       {{item['item']['key']}}:
    #         is_enabled: {{item['item']['value']['is_enabled']}}
    #         is_up: {{item['item']['value']['is_up']}}
    #   loop: "{{ interface_result.results }}"
    - name: CONFIGURATION DEPLOYMENT SUMMARY REPORT
      template: src=./templates/deployment_summary.j2 dest={{playbook_dir}}/results/{{inventory_hostname}}_deployment_report.txt

