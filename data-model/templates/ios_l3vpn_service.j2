
{% for vpn_type, vpn_data in services.items() %}
{% if vpn_type == 'l3vpn' %}
{% for service_type, service_vrfs in vpn_data.items() %}
{#--------VRF DEFINITION-------------#}
{% for vrf in service_vrfs %}
ip vrf {{ vrf['vrf_name'] }}
 rd {{ nodes[inventory_hostname]['routerid'] }}:{{ vrf['rd'] }}
{% for rt_in in vrf['rt_import']  %}
 route-target import {{ rt_in }}
{% endfor %}
{% for rt_out in vrf['rt_export']  %}
 route-target export {{ rt_out }}
{% endfor %}
{#--------VRF INTERFACES-------------#}
{% for site in vrf['sites'] %}
{% for link in site['links'] %}
{% if link['b_end'] == inventory_hostname %}
interface {{ link['b_end_intf'] }}
 description WAN L3VPN service for {{ vrf['customer'] }} site: {{ site['site_name'] }}
 ip vrf forwarding {{ vrf['vrf_name'] }}
 ip address {{ link['wan_ip_pfx'] | ipaddr('2') | ipaddr('address') }} 255.255.255.252
 negotiation auto
{% if service_type == 'wan' %}
router bgp {{ nodes[inventory_hostname]['asn'] }}
 address-family ipv4 vrf {{ vrf['vrf_name'] }}
  neighbor {{ link['wan_ip_pfx'] | ipaddr('2') | ipaddr('address') }} remote-as {{ vrf['remote_asn'] }}
  neighbor {{ link['wan_ip_pfx'] | ipaddr('2') | ipaddr('address') }} description "WAN L3VPN service for {{ vrf['customer'] }} site: {{ site['site_name'] }}"
  neighbor {{ link['wan_ip_pfx'] | ipaddr('2') | ipaddr('address') }} activate
 exit-address-family
{% elif service_type == 'internet' %}
router bgp {{ nodes[inventory_hostname]['asn'] }}
 address-family ipv4 vrf {{ vrf['vrf_name'] }}
  neighbor {{ link['wan_ip_pfx'] | ipaddr('2') | ipaddr('address') }} remote-as {{ site['asn'] }}
  neighbor {{ link['wan_ip_pfx'] | ipaddr('2') | ipaddr('address') }} description "INTERNET L3VPN service for {{ site['customer'] }} site: {{ site['site_name'] }}"
  neighbor {{ link['wan_ip_pfx'] | ipaddr('2') | ipaddr('address') }} activate
 exit-address-family
{% endif %}
{% endif %}
{% endfor %}
{% endfor %}
{#--------END VRF INTERFACES-------------#}
{% endfor %}
{#--------END VRF DEFINITION-------------#}
{% endfor %}
{% endif %}
{% endfor %}












{% for vrf_name, vrf in nodes[inventory_hostname]['vrfs'].items(): %}
{% if vrf['vrf_interfaces']: %}
ip vrf {{ vrf_name }}
 rd {{ nodes[inventory_hostname]['routerid'] }}:{{ vrf['rd'] }}
{% for rt_in in vrf['rt_import']  %}
 route-target import {{ rt_in }}
{% endfor %}
{% for rt_out in vrf['rt_export']  %}
 route-target export {{ rt_out }}
{% endfor %}
{% endif %}
{% endfor %}


{% for vrf_name, vrf in nodes[inventory_hostname]['vrfs'].items(): %}
{% if vrf['vrf_interfaces']: %}
{% for intf_name, intf in vrf['vrf_interfaces'].items() %}
interface {{ intf_name }}
 description {{ intf['description'] }} 
 ip vrf forwarding {{ vrf_name }}
 ip address {{ intf['ip'] | ipaddr('address') }} 255.255.255.252
 negotiation auto
{% endfor %}
{% endif %}
{% endfor %}